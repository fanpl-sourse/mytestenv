(window.webpackJsonplizard_service_sheet=window.webpackJsonplizard_service_sheet||[]).push([[3],{1356:function(t,e,n){"use strict";n.r(e);var b=n(3),i=n(2),g=n.n(i),f=n(1),o=n(421),r=n(0);var c,p=n(150),d=n(6),l=Object(f.c)(r.a.SET_UNPEEKED_COUNT,function(i){return function(t){var e=t.emitter,n=t.next;return e.emit("unpeekedCount.changed",i),n(i),i}}),a=Object(f.c)(r.a.GET_UNPEAKED_NOTIFICATION_COUNT,function(){return Object(p.a)(function(t){var e=t.dispatch,n=t.next;return e(Object(d.get)("notifications/unpeeked_count",{background:!0})).then(n)},"getUnpeekedNotificationCount")}),u=(Object(f.c)(r.a.GET_UNREAD_NOTIFICATION_COUNT,function(){return Object(p.a)(function(t){var e=t.dispatch,n=t.next;return e(Object(d.get)("notifications/unread_count",{background:!0})).then(n)},"getUnreadNotificationCount")}),Object(f.c)(r.a.GET_NOTIFICATIONS,function(t){var e=t.status,a=void 0===e?"all":e,n=t.prepend,u=void 0!==n&&n,i=t.peek,s=void 0!==i&&i;return Object(p.a)(function(t){var e=t.dispatch,n=t.next,i=(0,t.getState)();if(!u&&!function(t,e){var n=t.notifications.get(e+"HasMore");return"boolean"!=typeof n||n}(i,a))return Promise.resolve();var o="notifications?limit="+f.a+"&status="+a,r=function(t,e){return t.notifications.get(e)}(i,a),c=r&&r.size;return c&&!u&&(o+="&lt="+r.last().id),s&&(e(l(0)),o+="&action=peek"),e(Object(d.get)(o)).then(function(t){var e=u&&c?null:t.length===f.a;n({status:a,prepend:u,peek:s,items:t,hasMore:e})})},"getNotifications_"+a+"_"+u+"_"+s)})),s=Object(f.c)(r.a.MARK_NOTIFICATIONS_READ,function(i){return function(t){var e=t.dispatch,n=t.next;return e(Object(d.patch)("notifications/"+i+"?status=read")).then(function(){return n(i)})}}),h=(Object(f.c)(r.a.MARK_NOTIFICATIONS_ALL_READ,function(){return function(t){var e=t.dispatch,n=t.next;return e(Object(d.post)("notifications/action/read_all")).then(function(){return n(void 0)})}}),Object(f.c)(r.a.GET_SUBSCRIPTIONS,function(){return Object(p.a)(function(t){var e=t.dispatch,n=t.next;return e(Object(d.get)("subscribe")).then(n)},"getSubscriptions")})),O=(Object(f.c)(r.a.SWITCH_SUBSCRIPTIONS,function(o,r){return function(t){var e=t.dispatch,n=t.next,i=r?"turnon":"turnoff";return e(Object(d.post)("subscribe",{body:{channel:o,action:i}})).then(function(t){return null===t||!0===t.success?void n({channel:o,on:r}):Promise.reject(new Error(g()("设置失败")))})}}),n(11)),N=n(205),v=n(60),_=n(427),j=0,m=1,I=2,k=3,T=4,C=5,y=6,w=7,U=8,E=9,S=20,A=(c=O.PureComponent,Object(b.__extends)(x,c),x.prototype.componentDidMount=function(){var e=this;this.props.getSubscriptions(),(window.shimo&&window.shimo.emitter||f.f).on("notification",function(t){e.props.getUnpeekedNotificationCount(),e.getMessage(t).then(function(t){t&&"undefined"!=typeof Notification&&Notification&&("granted"===Notification.permission?e.showNotification(t):Notification.requestPermission(function(t){return"granted"===t}).then(function(){e.showNotification(t)}))})})},x.prototype.componentDidUpdate=function(t){t.onLine!==this.props.onLine&&this.props.onLine&&this.props.getUnpeekedNotificationCount()},x.prototype.showNotification=function(t){var e=this;this.props.enableDesktopNotice&&new Notification(t.title,{tag:t.id+"",body:t.body,icon:t.icon}).addEventListener("click",function(){t.url&&window.open(t.url,"_blank"),e.props.markNotificationRead(t.id),e.props.setUnpeekedCount(e.props.notifications.get("unpeekedCount")-1)})},x.prototype.filterCurrentNotifications=function(e,t){if(t)return t.filter(function(t){return t.get("targetId")===e}).first()},x.prototype.getMessage=function(d){var l=this;return this.props.getNotifications({status:"unread",prepend:!0}).then(function(){var t=l.filterCurrentNotifications(d.target_id,l.props.notifications.get("unread"));if(!t)return null;var e=t.get("id"),n=t.getIn(["user","name"])||g()("未知用户"),i=t.getIn(["user","avatar"]),o=t.getIn(["file","name"]),r=t.get("link"),c=Object(_.a)(t.get("msg"));switch(d.type){case j:var a=t.getIn(["file","guid"]),u=t.getIn(["file","type"]),s=Object(v.getFileUrl)(u,a),f=s?r.replace("/"+a,s):r;return{id:e,title:g()(D=D||Object(b.__makeTemplateObject)([""," 评论了「","」"],[""," 评论了「","」"]),n,o),body:'"'+c+'"',icon:i,url:f};case U:var p=t.get("commentId");return{id:e,title:g()(R=R||Object(b.__makeTemplateObject)([""," 点赞了 ",""],[""," 点赞了 ",""]),n,c),body:o,icon:i,url:p?r+"-"+p:r};case w:case E:return{id:e,title:""+n,body:o,icon:i,url:r};case m:return{id:e,title:n+" "+c,body:o,icon:i,url:r};case I:case k:case T:case C:return{id:e,title:n+" "+c,icon:i,url:r};case y:return null;case S:return{id:e,title:g()("系统通知"),body:c,url:r}}})},x.prototype.render=function(){return null},x);function x(){return null!==c&&c.apply(this,arguments)||this}var D,R,L={getNotifications:u,getUnpeekedNotificationCount:a,markNotificationRead:s,getSubscriptions:h,setUnpeekedCount:l},M=Object(N.connect)(function(t){return{onLine:Object(o.b)(t),notifications:t.notifications,enableDesktopNotice:t.subscriptions.desktop}},L)(A);e.default=M},427:function(t,e,n){"use strict";n.d(e,"a",function(){return i});var i=function(t){if(!t)return"";var e=document.createElement("div");return e.innerHTML=t,(e.innerText||e.textContent||"").trim()}}}]);
//# sourceMappingURL=notification.1fe5acf3.js.map